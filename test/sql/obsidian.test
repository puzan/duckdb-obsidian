# name: test/sql/obsidian.test
# description: test obsidian extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require obsidian

require json

# obsidian_notes returns filename, basename, filepath, relative_path columns
query IIII
SELECT filename, basename, filepath, relative_path FROM obsidian_notes('test/sql/vault') ORDER BY filename;
----
note_a.md	note_a	test/sql/vault/note_a.md	note_a.md
note_b.md	note_b	test/sql/vault/subdir/note_b.md	subdir/note_b.md
note_c.md	note_c	test/sql/vault/note_c.md	note_c.md
note_d.md	note_d	test/sql/vault/note_d.md	note_d.md
note_e.md	note_e	test/sql/vault/note_e.md	note_e.md
note_f.md	note_f	test/sql/vault/note_f.md	note_f.md
note_g.md	note_g	test/sql/vault/note_g.md	note_g.md
note_h.md	note_h	test/sql/vault/note_h.md	note_h.md
note_i.md	note_i	test/sql/vault/note_i.md	note_i.md
note_j.md	note_j	test/sql/vault/note_j.md	note_j.md
note_k.md	note_k	test/sql/vault/note_k.md	note_k.md

# first_header: NULL when note has no H1 heading
query II
SELECT filename, first_header FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_c.md';
----
note_c.md	NULL

# first_header: returns H1 even when frontmatter title is present
query II
SELECT filename, first_header FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_e.md';
----
note_e.md	Another title

# first_header: returns H1 heading
query II
SELECT filename, first_header FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_f.md';
----
note_f.md	Heading As Title

# properties: NULL when no frontmatter
query II
SELECT filename, properties FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_a.md';
----
note_a.md	NULL

# properties: JSON object with all frontmatter fields
query II
SELECT filename, properties FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_c.md';
----
note_c.md	{"title": "Title From Frontmatter","tags": ["test"]}

# properties: can query specific field with json_extract_string
query II
SELECT filename, json_extract_string(properties, '$.title') FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_c.md';
----
note_c.md	Title From Frontmatter

# properties: filter by tag presence using json_contains
query I
SELECT filename FROM obsidian_notes('test/sql/vault') WHERE json_contains(properties->'$.tags', '"projects"') ORDER BY filename;
----
note_i.md

# internal_links: empty list when note has no wiki-links
query II
SELECT filename, internal_links FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_a.md';
----
note_a.md	[]

# internal_links: all link types parsed correctly (basic, alias, header, block_ref, header+alias)
query II
SELECT filename, internal_links FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_k.md';
----
note_k.md	[{'target': note_a, 'display_name': NULL, 'header': NULL, 'block_ref': NULL}, {'target': note_b, 'display_name': NULL, 'header': NULL, 'block_ref': NULL}, {'target': note_c, 'display_name': My Alias, 'header': NULL, 'block_ref': NULL}, {'target': note_d, 'display_name': NULL, 'header': Some Header, 'block_ref': NULL}, {'target': note_e, 'display_name': NULL, 'header': NULL, 'block_ref': abc123}, {'target': note_f, 'display_name': Label, 'header': Section, 'block_ref': NULL}]

# internal_links: link from frontmatter is included
query II
SELECT filename, internal_links[1].target FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_k.md';
----
note_k.md	note_a

# internal_links: filter notes that link to a specific target
query I
SELECT filename FROM obsidian_notes('test/sql/vault') WHERE list_contains(list_transform(internal_links, l -> l.target), 'note_b') ORDER BY filename;
----
note_k.md

# obsidian_notes errors on a directory without .obsidian
statement error
SELECT * FROM obsidian_notes('test/sql/not_a_vault');
----
not an Obsidian vault

# obsidian_notes() without arguments uses the current working directory
# The test runner runs from the project root, which is not a vault â€” verify graceful error
statement error
SELECT * FROM obsidian_notes();
----
not an Obsidian vault
