# name: test/sql/obsidian.test
# description: test obsidian extension
# group: [sql]

# Require statement will ensure this test is run with this extension loaded
require obsidian

# obsidian_notes returns filename, filepath, relative_path and title columns
query IIII
SELECT filename, filepath, relative_path, title FROM obsidian_notes('test/sql/vault') ORDER BY filename;
----
note_a.md	test/sql/vault/note_a.md	note_a.md	Note A
note_b.md	test/sql/vault/subdir/note_b.md	subdir/note_b.md	Note B
note_c.md	test/sql/vault/note_c.md	note_c.md	Title From Frontmatter
note_d.md	test/sql/vault/note_d.md	note_d.md	note_d
note_e.md	test/sql/vault/note_e.md	note_e.md	Title From Frontmatter
note_f.md	test/sql/vault/note_f.md	note_f.md	Heading As Title
note_g.md	test/sql/vault/note_g.md	note_g.md	Quoted Title
note_h.md	test/sql/vault/note_h.md	note_h.md	Title From Heading
note_i.md	test/sql/vault/note_i.md	note_i.md	Note With Multiple Tags
note_j.md	test/sql/vault/note_j.md	note_j.md	Default Title
note_k.md	test/sql/vault/note_k.md	note_k.md	Note With Links

# title: frontmatter takes priority over H1 heading
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_e.md';
----
note_e.md	Title From Frontmatter

# title: H1 heading used when frontmatter has no title property
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_f.md';
----
note_f.md	Heading As Title

# title: H1 used when there is no frontmatter at all
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_a.md';
----
note_a.md	Note A

# title: quoted string value in frontmatter (ryml >> operator abort regression)
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_g.md';
----
note_g.md	Quoted Title

# title: malformed YAML frontmatter (container as key) falls back to H1 (ryml abort regression)
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_h.md';
----
note_h.md	Title From Heading

# title: filename stem used when no frontmatter and no heading (double-free regression)
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_d.md';
----
note_d.md	note_d

# properties: NULL when no frontmatter
query II
SELECT filename, properties FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_a.md';
----
note_a.md	NULL

# properties: JSON object with all frontmatter fields
query II
SELECT filename, properties FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_c.md';
----
note_c.md	{"title": "Title From Frontmatter","tags": ["test"]}

# properties: can query specific field with json_extract_string
query II
SELECT filename, json_extract_string(properties, '$.title') FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_c.md';
----
note_c.md	Title From Frontmatter

# properties: filter by tag presence using json_contains
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE json_contains(properties->'$.tags', '"projects"') ORDER BY filename;
----
note_i.md	Note With Multiple Tags

# title_property: custom frontmatter property used as title source
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault', title_property='name') WHERE filename = 'note_j.md';
----
note_j.md	Custom Property Title

# title_property: default is 'title' when parameter is omitted
query II
SELECT filename, title FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_j.md';
----
note_j.md	Default Title

# internal_links: empty list when note has no wiki-links
query II
SELECT filename, internal_links FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_a.md';
----
note_a.md	[]

# internal_links: all link types parsed correctly (basic, alias, header, block_ref, header+alias)
query II
SELECT filename, internal_links FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_k.md';
----
note_k.md	[{'target': note_a, 'display_name': NULL, 'header': NULL, 'block_ref': NULL}, {'target': note_b, 'display_name': NULL, 'header': NULL, 'block_ref': NULL}, {'target': note_c, 'display_name': My Alias, 'header': NULL, 'block_ref': NULL}, {'target': note_d, 'display_name': NULL, 'header': Some Header, 'block_ref': NULL}, {'target': note_e, 'display_name': NULL, 'header': NULL, 'block_ref': abc123}, {'target': note_f, 'display_name': Label, 'header': Section, 'block_ref': NULL}]

# internal_links: link from frontmatter is included
query II
SELECT filename, internal_links[1].target FROM obsidian_notes('test/sql/vault') WHERE filename = 'note_k.md';
----
note_k.md	note_a

# internal_links: filter notes that link to a specific target
query I
SELECT filename FROM obsidian_notes('test/sql/vault') WHERE list_contains(list_transform(internal_links, l -> l.target), 'note_b') ORDER BY filename;
----
note_k.md

# obsidian_notes errors on a directory without .obsidian
statement error
SELECT * FROM obsidian_notes('test/sql/not_a_vault');
----
not an Obsidian vault
